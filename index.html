<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Allergikort – Demo</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 820px; margin: 24px auto; padding: 0 16px; }
    h1 { margin: 0 0 6px; }
    .muted { opacity: .75; }
    .toprow { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin: 10px 0 16px; }
    select, input[type="text"] { padding: 10px; border-radius: 12px; border: 1px solid #ccc; }
    button { padding: 10px 14px; border-radius: 12px; border: 1px solid #ccc; cursor: pointer; }
    fieldset { border: 1px solid #ddd; border-radius: 14px; padding: 12px; margin: 12px 0; }
    legend { padding: 0 8px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 8px 14px; }
    label { display: inline-flex; gap: 8px; align-items: center; }
    .linkbox { word-break: break-all; background: #f6f6f6; padding: 10px; border-radius: 12px; border: 1px solid #eee; }
    #qrcode { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Skapa allergikort (demo)</h1>
  <div class="muted">Välj allergener. Skapa QR-kod. Skanna → tydlig lista för personal.</div>

  <div class="toprow">
    <label>Språk:
      <select id="lang">
        <option value="sv" selected>Svenska</option>
        <option value="en">English</option>
      </select>
    </label>

    <label>Känslighet:
      <select id="sens">
        <option value="normal" selected>Normal</option>
        <option value="high">Mycket känslig</option>
      </select>
    </label>

    <button id="selectNone">Avmarkera allt</button>
    <button id="selectCommon">Välj “vanliga”</button>
  </div>

  <div id="formMount"></div>

  <div style="margin-top: 14px;">
    <div style="margin-bottom:6px;">Extra info (valfritt):</div>
    <input id="note" style="width:100%;" placeholder="t.ex. 'spår kan vara farligt' / 'rena redskap behövs'"/>
  </div>

  <div class="toprow" style="margin-top: 14px;">
    <button id="make">Skapa QR-kod</button>
    <button id="copy" disabled>Kopiera länk</button>
  </div>

  <h2 style="margin-top:18px;">QR-kod</h2>
  <div id="qrcode"></div>

  <h3>Länk (för test)</h3>
  <div class="linkbox" id="linkbox">Skapa QR-kod för att få en länk…</div>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);

    // ---- KATALOG: kategorier + MASSOR av allergener ----
    // id = kort kod i URL, label = text i UI.
    // common: används av "Välj vanliga"
    const CATEGORIES = [
      {
        key: "gluten",
        sv: "Spannmål / Gluten",
        en: "Cereals / Gluten",
        items: [
          { id: "gluten", sv:"Gluten", en:"Gluten", common:true },
          { id: "wheat", sv:"Vete", en:"Wheat", common:true },
          { id: "rye", sv:"Råg", en:"Rye" },
          { id: "barley", sv:"Korn", en:"Barley" },
          { id: "oats", sv:"Havre", en:"Oats" }
        ]
      },
      {
        key: "dairyEgg",
        sv: "Mejeri & Ägg",
        en: "Dairy & Egg",
        items: [
          { id: "milk", sv:"Mjölk", en:"Milk", common:true },
          { id: "lactose", sv:"Laktos", en:"Lactose" },
          { id: "casein", sv:"Kasein", en:"Casein" },
          { id: "egg", sv:"Ägg", en:"Egg", common:true }
        ]
      },
      {
        key: "fishSea",
        sv: "Fisk, Skaldjur & Blötdjur",
        en: "Fish, Crustaceans & Molluscs",
        items: [
          { id: "fish", sv:"Fisk", en:"Fish", common:true },
          { id: "crust", sv:"Skaldjur (räka/krabba/hummer)", en:"Crustaceans (shrimp/crab/lobster)", common:true },
          { id: "moll", sv:"Blötdjur (musslor/ostron/bläckfisk)", en:"Molluscs (mussels/oysters/squid)" }
        ]
      },
      {
        key: "legumes",
        sv: "Baljväxter",
        en: "Legumes",
        items: [
          { id: "soy", sv:"Soja", en:"Soy", common:true },
          { id: "pea", sv:"Ärta", en:"Pea" },
          { id: "bean", sv:"Böna", en:"Beans" },
          { id: "lentil", sv:"Lins", en:"Lentil" },
          { id: "chickpea", sv:"Kikärta", en:"Chickpea" },
          { id: "lupin", sv:"Lupin", en:"Lupin" } // EU-14 allergen
        ]
      },
      {
        key: "nuts",
        sv: "Nötter (inkl. jordnöt här i demo)",
        en: "Nuts (incl. peanut here in demo)",
        items: [
          { id: "peanut", sv:"Jordnöt", en:"Peanut", common:true }, // flyttad hit
          { id: "almond", sv:"Mandel", en:"Almond", common:true },
          { id: "hazelnut", sv:"Hasselnöt", en:"Hazelnut", common:true },
          { id: "walnut", sv:"Valnöt", en:"Walnut", common:true },
          { id: "cashew", sv:"Cashewnöt", en:"Cashew", common:true },
          { id: "pecan", sv:"Pekannöt", en:"Pecan" },
          { id: "pistachio", sv:"Pistagenöt", en:"Pistachio", common:true },
          { id: "macadamia", sv:"Macadamianöt", en:"Macadamia" },
          { id: "brazil", sv:"Paranöt", en:"Brazil nut" },
          { id: "pinenut", sv:"Pinjenöt", en:"Pine nut" },
          { id: "coconut", sv:"Kokos", en:"Coconut" }
        ]
      },
      {
        key: "seedsSpice",
        sv: "Frön, Kryddor & Övrigt (vanligt i café)",
        en: "Seeds, Spices & Other (common in cafés)",
        items: [
          { id: "sesame", sv:"Sesam", en:"Sesame", common:true },     // EU-14
          { id: "mustard", sv:"Senap", en:"Mustard" },               // EU-14
          { id: "celery", sv:"Selleri", en:"Celery" },               // EU-14
          { id: "sulfite", sv:"Sulfiter (t.ex. vin/torkad frukt)", en:"Sulphites (e.g. wine/dried fruit)" }, // EU-14
          { id: "sunflower", sv:"Solrosfrö", en:"Sunflower seed" },
          { id: "poppy", sv:"Vallmofrö", en:"Poppy seed" },
          { id: "pumpkin", sv:"Pumpakärnor", en:"Pumpkin seeds" },
          { id: "chia", sv:"Chiafrö", en:"Chia" },
          { id: "flax", sv:"Linfrö", en:"Flaxseed" },
          { id: "cinnamon", sv:"Kanel", en:"Cinnamon" },
          { id: "vanilla", sv:"Vanilj", en:"Vanilla" },
          { id: "cocoa", sv:"Kakao", en:"Cocoa" },
          { id: "coffee", sv:"Kaffe", en:"Coffee" }
        ]
      },
      {
        key: "fruitVeg",
        sv: "Frukt & Grönt (vanliga korsreaktioner)",
        en: "Fruits & Veg (common cross-reactions)",
        items: [
          { id: "apple", sv:"Äpple", en:"Apple" },
          { id: "pear", sv:"Päron", en:"Pear" },
          { id: "kiwi", sv:"Kiwi", en:"Kiwi" },
          { id: "strawberry", sv:"Jordgubbe", en:"Strawberry" },
          { id: "stonefruit", sv:"Stenfrukter (persika/plommon/aprikos)", en:"Stone fruits (peach/plum/apricot)" },
          { id: "banana", sv:"Banan", en:"Banana" },
          { id: "tomato", sv:"Tomat", en:"Tomato" },
          { id: "carrot", sv:"Morot", en:"Carrot" },
          { id: "avocado", sv:"Avokado", en:"Avocado" }
        ]
      },
      {
        key: "other",
        sv: "Övrigt",
        en: "Other",
        items: [
          { id: "gelatin", sv:"Gelatin", en:"Gelatin" },
          { id: "honey", sv:"Honung", en:"Honey" },
          { id: "yeast", sv:"Jäst", en:"Yeast" }
        ]
      }
    ];

    // Bygg formuläret automatiskt
    const mount = $("formMount");
    function buildForm() {
      mount.innerHTML = "";
      for (const cat of CATEGORIES) {
        const fs = document.createElement("fieldset");
        const lg = document.createElement("legend");
        lg.textContent = $("lang").value === "en" ? cat.en : cat.sv;
        fs.appendChild(lg);

        const grid = document.createElement("div");
        grid.className = "grid";

        for (const it of cat.items) {
          const id = `a_${it.id}`;
          const lab = document.createElement("label");
          lab.innerHTML = `<input type="checkbox" id="${id}"> <span>${$("lang").value === "en" ? it.en : it.sv}</span>`;
          grid.appendChild(lab);
        }
        fs.appendChild(grid);
        mount.appendChild(fs);
      }
    }

    $("lang").addEventListener("change", buildForm);

    function setAll(checked) {
      for (const cat of CATEGORIES) {
        for (const it of cat.items) {
          const cb = document.getElementById(`a_${it.id}`);
          if (cb) cb.checked = checked;
        }
      }
    }

    function setCommon() {
      setAll(false);
      for (const cat of CATEGORIES) {
        for (const it of cat.items) {
          if (it.common) {
            const cb = document.getElementById(`a_${it.id}`);
            if (cb) cb.checked = true;
          }
        }
      }
    }

    $("selectNone").addEventListener("click", () => setAll(false));
    $("selectCommon").addEventListener("click", () => setCommon());

    function baseUrlForCard() {
      const noQuery = location.href.split("?")[0];
      let base = noQuery;
      if (base.endsWith("index.html")) base = base.slice(0, -("index.html".length));
      if (!base.endsWith("/")) base += "/";
      return base + "card.html";
    }

    function getSelectedIds() {
      const selected = [];
      const nuts = [];

      // Vi lägger ALLA valda i "a", men för visning vill vi också särskilja nötter.
      // Därför skickar vi "nuts" separat också.
      for (const cat of CATEGORIES) {
        for (const it of cat.items) {
          const cb = document.getElementById(`a_${it.id}`);
          if (cb && cb.checked) {
            if (cat.key === "nuts") nuts.push(it.id);
            else selected.push(it.id);
          }
        }
      }
      return { selected, nuts };
    }

    function buildUrl() {
      const { selected, nuts } = getSelectedIds();
      const params = new URLSearchParams();
      params.set("lang", $("lang").value);
      params.set("sens", $("sens").value);

      // Kompakt lagring
      if (selected.length) params.set("a", selected.join(","));
      if (nuts.length) params.set("nuts", nuts.join(","));

      const note = $("note").value.trim();
      if (note) params.set("note", note);

      return `${baseUrlForCard()}?${params.toString()}`;
    }

    // Init
    buildForm();

    $("make").addEventListener("click", () => {
      const url = buildUrl();

      $("qrcode").innerHTML = "";
      new QRCode($("qrcode"), { text: url, width: 220, height: 220 });

      $("linkbox").textContent = url;
      $("copy").disabled = false;

      $("copy").onclick = async () => {
        try {
          await navigator.clipboard.writeText(url);
          $("copy").textContent = "Kopierad!";
          setTimeout(() => $("copy").textContent = "Kopiera länk", 1200);
        } catch {
          alert("Kunde inte kopiera automatiskt. Kopiera länken manuellt.");
        }
      };
    });
  </script>
</body>
</html>
